# GitHub Actions Federated Credential Authentication Fix

## Issue Summary
**Date**: January 10, 2025  
**Error**: AADSTS700213 - No matching federated identity record found for presented assertion  
**Root Cause**: GitHub secrets contained wrong Client ID for the App Registration

## Problem Details

### Error Message
```
Error: AADSTS700213: No matching federated identity record found for presented assertion subject 'repo:Abernaughty/PokeData:environment:staging'. 
Check your federated identity credential Subject, Audience and Issuer against the presented assertion.
```

### What GitHub Actions Was Sending
- **Subject**: `repo:Abernaughty/PokeData:environment:staging`
- **Audience**: `api://AzureADTokenExchange`
- **Issuer**: `https://token.actions.githubusercontent.com`

### Azure Federated Credential Configuration (Correct)
The federated credential was properly configured in Azure with:
- **Subject**: `repo:Abernaughty/PokeData:environment:staging`
- **Audience**: `api://AzureADTokenExchange`
- **Issuer**: `https://token.actions.githubusercontent.com`
- **Entity Type**: Environment
- **Environment Name**: staging

## Root Cause
The GitHub secret `AZUREAPPSERVICE_CLIENTID_2373F1476CEC447D9D3BE7FB74677C2A` contained the wrong Client ID. These auto-generated secret names (with hex suffixes) were likely created by Azure deployment tools for a different App Registration.

## Solution

### 1. Identify Correct Client ID
- Navigate to Azure Portal → Microsoft Entra ID → App registrations
- Find the `github-actions-pokedata` app registration
- Copy the **Application (client) ID** from the Overview page

### 2. Update GitHub Secrets
- Go to GitHub repository → Settings → Secrets and variables → Actions
- Update the following secrets with correct values:
  - `AZUREAPPSERVICE_CLIENTID_2373F1476CEC447D9D3BE7FB74677C2A` → Client ID from App Registration
  - `AZUREAPPSERVICE_TENANTID_006F21A676F04E49964C0606826AE31A` → Tenant ID from Azure
  - `AZUREAPPSERVICE_SUBSCRIPTIONID_4EABEB599BB34C8A8E60471FB3D1EDD3` → Subscription ID from Azure

### 3. Verify Role Assignments
Ensure the App Registration has proper permissions:
- Go to Function App → Access control (IAM) → Role assignments
- Verify the service principal has "Contributor" or "Website Contributor" role

## Additional Federated Credentials Needed

For complete CI/CD pipeline, create two federated credentials:

### Staging Environment
- **Subject**: `repo:Abernaughty/PokeData:environment:staging`
- **Entity Type**: Environment
- **Environment**: staging

### Production Environment
- **Subject**: `repo:Abernaughty/PokeData:environment:production`
- **Entity Type**: Environment
- **Environment**: production

## Key Learnings

1. **Subject Format with Environments**: When using GitHub environments in workflows, the subject format is `repo:{owner}/{repo}:environment:{environment-name}`

2. **Secret Naming**: The hex suffixes in secret names are auto-generated by Azure tools. When switching to federated credentials, these need to be updated with your own App Registration's values.

3. **Exact Match Required**: The subject claim must match EXACTLY between GitHub Actions and Azure federated credential configuration.

4. **Environment-Based Authentication**: Using GitHub environments provides better security and enables manual approval gates for production deployments.

## Verification
After updating secrets, the GitHub Actions workflow successfully authenticated and deployed to Azure Functions using federated credentials, eliminating the need for service principal passwords or certificates.
